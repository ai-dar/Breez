<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
</head>
<body>
    <h1>Admin Panel</h1>
    <form id="emailForm">
        <label for="subject">Subject:</label>
        <input type="text" id="subject" name="subject" required>
        <br>
        <label for="body">Message:</label>
        <textarea id="body" name="body" required></textarea>
        <br>
        <label for="attachments">Attachments:</label>
        <input type="file" id="attachments" name="attachments" multiple>
        <br>
        <button type="submit">Send Emails</button>
    </form>
    <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã</h2>
    <table border="1">
        <thead>
            <tr>
                <th>ID –ß–∞—Ç–∞</th>
                <th>–ö–ª–∏–µ–Ω—Ç</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="chats-list"></tbody>
    </table>
    <script>
       document.getElementById("emailForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData();
        formData.append("subject", document.getElementById("subject").value);
        formData.append("body", document.getElementById("body").value);

        const attachments = document.getElementById("attachments").files;
        for (let i = 0; i < attachments.length; i++) {
            formData.append("attachments", attachments[i]);
        }

        const response = await fetch("/admin/send-emails", {
            method: "POST",
            body: formData,
        });

        if (response.ok) {
            alert("Emails sent successfully!");
        } else {
            alert("Failed to send emails.");
        }
    });
    async function loadChats() {
    fetch("/api/admin/active-chats", { method: "GET", credentials: "include" })
        .then(response => response.json())
        .then(data => {
            const table = document.getElementById("chats-list");
            table.innerHTML = "";

            data.forEach(chat => {
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td>${chat.chat_id || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}</td>
                    <td>${chat.user_name || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}</td>
                    <td>
                        <a href="/static/chat.html?chat_id=${chat.chat_id}">–ü–µ—Ä–µ–π—Ç–∏</a>
                        <button onclick="closeChat('${chat.chat_id}')">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </td>
                `;

                table.appendChild(row);
            });
        })
        .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:", error));
}
async function closeChat(chatId) {
    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?")) return;

    fetch(`/api/admin/close-chat?chat_id=${chatId}`, {
        method: "POST",
        credentials: "include"
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞");
        }
        return response.json();
    })
    .then(data => {
        alert("–ß–∞—Ç –∑–∞–∫—Ä—ã—Ç —É—Å–ø–µ—à–Ω–æ!");
        loadChats(); // üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
    })
    .catch(error => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞:", error);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å —á–∞—Ç");
    });
}


// –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener("DOMContentLoaded", loadChats);
    </script>
</body>
</html>
