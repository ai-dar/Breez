<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Breez</title>
    <link rel="stylesheet" href="/static/home.css">
</head>
<body>
    <div class="header">
        <h1>Breez</h1>
        <p id="welcomeMessage">Welcome back!</p>
    </div>

    <div id="support-chat">
        <h2>–ß–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</h2>
        <p id="chat-link-container">
            <button id="start-chat-button" style="display: none;" onclick="startChat()">–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç</button>
        </p>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="controls">
        <input type="text" id="filterInput" placeholder="Filter by content or user">
        <select id="sortSelect">
            <option value="created_at">Sort by Date</option>
            <option value="user_id">Sort by User</option>
        </select>
        <button onclick="applyFilterSort()">Apply</button>
    </div>

    <!-- –ü–æ–ª–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–≤–∏—Ç–æ–≤ -->
    <div class="tweet-box">
        <textarea id="tweetContent" placeholder="What's happening?" rows="3" required></textarea>
        <button id="tweetButton">Tweet</button>
        <button id="payButton">–û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ç–≤–∏—Ç–æ–≤ -->
    <div id="tweets" class="tweets"></div>

    <button id="adminButton" style="display: none; margin-top: 20px;">Go to Admin Panel</button>

    <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π -->
    <div class="pagination">
        <button id="prevPage" onclick="changePage(-1)">Previous</button>
        <span id="currentPage">1</span>
        <button id="nextPage" onclick="changePage(1)">Next</button>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        async function getUserID() {
        try {
            const response = await fetch("/user/me", { method: "GET", credentials: "include" });
            if (!response.ok) throw new Error("–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");

            const data = await response.json();
            return data.user_id;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è user_id:", error);
            return null;
        }
    }

    async function checkAuth() {
        const userId = await getUserID();
        if (!userId) {
            window.location.href = "/static/index.html";
        } else {
            checkChat();
        }
    }

        console.log(document.cookie);
        async function checkChat() {
        const userId = await getUserID();
        if (!userId) return;

        fetch(`/api/check-active-chat?user_id=${userId}`, { // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
            method: "GET",
            credentials: "include"
        })
        .then(response => response.json())
        .then(data => {
            console.log("üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ check-active-chat:", data);
            const chatContainer = document.getElementById("chat-link-container");
            if (data.active) {
                chatContainer.innerHTML = `<a href="chat.html?chat_id=${data.chat_id}">–ü–µ—Ä–µ–π—Ç–∏ –≤ —á–∞—Ç</a>`;
            } else {
                document.getElementById("start-chat-button").style.display = "block";
            }
        })
        .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–∞—Ç–∞:", error));
    }

    async function startChat() {
        const userId = await getUserID();
        if (!userId) {
            console.error("–û—à–∏–±–∫–∞: user_id –Ω–µ –Ω–∞–π–¥–µ–Ω!");
            return;
        }

        fetch(`/api/start-chat?user_id=${userId}`, {
            method: "POST",
            credentials: "include"
        })
        .then(response => response.json())
        .then(data => {
            if (data.chat_id) {
                window.location.href = `chat.html?chat_id=${data.chat_id}`;
            } else {
                alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞");
            }
        })
        .catch(error => {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞:", error);
            alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
        });
    }

        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        document.getElementById("payButton").addEventListener("click", function() {
    const paymentData = {
        user_id: 123,  // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
        amount: 9.99,  // –°—É–º–º–∞ –ø–æ–¥–ø–∏—Å–∫–∏
        currency: "USD",
        service_id: "premium_subscription"
    };

    fetch("http://localhost:8080/pay", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.redirect_url) {
            window.location.href = data.redirect_url; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã
        } else {
            alert("–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã");
        }
    })
    .catch(error => {
        alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
        console.error("–û—à–∏–±–∫–∞:", error);
    });
});

        const userName = getCookie("user_name");
        if (userName) {
            document.getElementById("welcomeMessage").textContent = `Welcome back, ${userName}!`;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function checkUserRole() {
            const response = await fetch("/user/me", { method: "GET", credentials: "include" });
            if (response.ok) {
                const user = await response.json();
                if (user.role === "admin") {
                    const adminButton = document.getElementById("adminButton");
                    adminButton.style.display = "block";
                    adminButton.addEventListener("click", () => {
                        window.location.href = "/static/admin.html";
                    });
                }
            } else {
                console.error("Failed to fetch user info");
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–≤–∏—Ç–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        async function loadTweets(filter = "", sort = "created_at", page = 1) {
    try {
        const url = new URL('/tweets', window.location.origin);
        url.searchParams.append('filter', filter);
        url.searchParams.append('sort', sort);
        url.searchParams.append('page', page);

        const response = await fetch(url, { method: 'GET', credentials: 'include' });

        if (!response.ok) {
            if (response.status === 404) {
                alert("Page does not exist. Staying on the current page.");
            } else {
                const errorText = await response.text();
                alert(`Failed to load tweets: ${errorText}`);
            }
            return;
        }

        const data = await response.json();
        const tweets = data.tweets;
        totalPages = data.total_pages;

        const tweetsContainer = document.getElementById('tweets');
        tweetsContainer.innerHTML = '';

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        let isAdmin = false;
        try {
            const userResponse = await fetch("/user/me", { method: "GET", credentials: "include" });
            if (userResponse.ok) {
                const user = await userResponse.json();
                console.log("User data:", user); // –õ–æ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                isAdmin = user.role === "admin";
                console.log("Is admin:", isAdmin); // –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            } else {
                console.error("Failed to fetch user data:", userResponse.status);
            }
        } catch (err) {
            console.error("Error fetching user data:", err);
        }

        tweets.forEach(tweet => {
            const tweetElement = document.createElement('div');
            tweetElement.classList.add('tweet');
            tweetElement.innerHTML = `
                <p>${tweet.content}</p>
                <small>By: ${tweet.user.name || 'Unknown'} | Likes: ${tweet.likes}</small>
                <button onclick="likeTweet(${tweet.id})">Like</button>
                ${isAdmin ? `
                    <button onclick="editTweet(${tweet.id}, '${tweet.content}')">Edit</button>
                    <button onclick="deleteTweet(${tweet.id})">Delete</button>
                ` : ''}
            `;
            tweetsContainer.appendChild(tweetElement);
        });

        document.getElementById('currentPage').textContent = currentPage;
    } catch (error) {
        alert(`Failed to load tweets: ${error.message}`);
        console.error("Error loading tweets:", error);
    }
}

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Ç–≤–∏—Ç–∞
        async function postTweet() {
            const content = document.getElementById('tweetContent').value.trim();
            if (!content) {
                alert('Tweet content cannot be empty!');
                return;
            }

            const response = await fetch('/tweets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content }),
            });

            if (response.ok) {
                const data = await response.json();
                alert(`Tweet created successfully by ${data.user}!`);
                document.getElementById('tweetContent').value = '';
                loadTweets(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–≤–∏—Ç–æ–≤
            } else {
                alert('Failed to tweet');
            }
        }
        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–≤–∏—Ç–∞
        async function editTweet(tweetId, currentContent) {
        const newContent = prompt("Edit your tweet:", currentContent);
        if (!newContent || newContent.trim() === "") {
            alert("Tweet content cannot be empty!");
            return;
        }

        const response = await fetch("/admin/tweet/update", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tweet_id: tweetId, content: newContent }),
        });

        if (response.ok) {
            alert("Tweet updated successfully!");
            loadTweets();
        } else {
            alert("Failed to update tweet");
        }
    }
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–≤–∏—Ç–∞
    async function deleteTweet(tweetId) {
        if (!confirm("Are you sure you want to delete this tweet?")) {
            return;
        }

        const response = await fetch("/admin/tweet/delete", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tweet_id: tweetId }),
        });

        if (response.ok) {
            alert("Tweet deleted successfully!");
            loadTweets();
        } else {
            alert("Failed to delete tweet");
        }
    }

        // –õ–∞–π–∫ –¥–ª—è —Ç–≤–∏—Ç–∞
        async function likeTweet(tweetId) {
            const response = await fetch('/like', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tweetId }),
            });

            if (response.ok) {
                loadTweets();
            } else {
                alert('Failed to like tweet');
            }
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        function applyFilterSort() {
            const filter = document.getElementById('filterInput').value;
            const sort = document.getElementById('sortSelect').value;
            loadTweets(filter, sort, 1);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage > totalPages || newPage < 1) {
                alert("No more pages");
                return;
            }
            currentPage = newPage;
            loadTweets("", "created_at", currentPage);
        }
            checkChat();
        
        document.getElementById('tweetButton').addEventListener('click', postTweet);
        checkUserRole();
        loadTweets();
    </script>
</body>
</html>
